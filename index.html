<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educational AI Assistant with Diagrams</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .diagram-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .diagram-image {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }
        .chat-container {
            height: 70vh;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .user-message {
            background-color: #f1f0f0;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 80%;
            margin-left: auto;
        }
        .assistant-message {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Educational AI Assistant with Diagrams</h1>
        
        <div class="chat-container" id="chatContainer"></div>
        
        <div class="input-group mb-3">
            <input type="text" id="promptInput" class="form-control" placeholder="Ask an educational question...">
            <button class="btn btn-primary" type="button" id="sendButton">Send</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const promptInput = document.getElementById('promptInput');
            const sendButton = document.getElementById('sendButton');
            const chatContainer = document.getElementById('chatContainer');
            
            // Session management
            const sessionId = localStorage.getItem('sessionId') || generateUUID();
            let currentChatId = localStorage.getItem('chatId') || null;
            
            // Store session ID for persistence
            localStorage.setItem('sessionId', sessionId);
            
            // Handle Enter key
            promptInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            function sendMessage() {
                const query = promptInput.value.trim();
                if (!query) return;

                // Add user message to chat
                addMessageToChat('user', query);
                promptInput.value = '';

                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'assistant-message';
                loadingDiv.id = 'loading-message';
                loadingDiv.textContent = 'Thinking...';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // Send request to backend
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        query: query,
                        chat_id: currentChatId,
                        session_id: sessionId
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    // Remove loading indicator
                    const loadingElement = document.getElementById('loading-message');
                    if (loadingElement) {
                        loadingElement.remove();
                    }

                    // Update chat ID
                    currentChatId = data.chat_id;
                    localStorage.setItem('chatId', currentChatId);

                    // Add assistant response to chat with diagram if available
                    addMessageToChat('assistant', data.response, data.diagram_path);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Remove loading indicator
                    const loadingElement = document.getElementById('loading-message');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // Show error message
                    addMessageToChat('assistant', 'Sorry, there was an error processing your request.');
                });
            }

            function addMessageToChat(sender, text, diagramPath = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'user' ? 'user-message' : 'assistant-message';
                
                // Add text response
                const textElement = document.createElement('div');
                textElement.innerHTML = formatText(text);
                messageDiv.appendChild(textElement);
                
                // Add diagram if available
                if (diagramPath) {
                    const diagramContainer = document.createElement('div');
                    diagramContainer.className = 'diagram-container';
                    
                    const diagramTitle = document.createElement('h5');
                    diagramTitle.textContent = 'Related Diagram:';
                    diagramContainer.appendChild(diagramTitle);
                    
                    const diagramDiv = document.createElement('div');
                    diagramDiv.className = 'mb-3';
                    
                    // Add diagram image
                    const img = document.createElement('img');
                    img.className = 'diagram-image';
                    img.src = `/api/diagrams/image?path=${encodeURIComponent(diagramPath)}`;
                    img.alt = "Relevant diagram";
                    diagramDiv.appendChild(img);
                    
                    diagramContainer.appendChild(diagramDiv);
                    messageDiv.appendChild(diagramContainer);
                }
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            function formatText(text) {
                // Convert line breaks to HTML breaks
                return text.replace(/\n/g, '<br>');
            }
            
            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        });
    </script>
</body>
</html>